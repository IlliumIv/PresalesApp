@page "/sales-overview"
@using ChartJs.Blazor.PieChart;
@using Google.Protobuf.WellKnownTypes;
@using PresalesMonitor.Shared;
@using PresalesMonitor.Client.Web.Views;
@using PresalesMonitor.Client.Web.Helpers;
@using System.Threading;
@using Period = PresalesMonitor.Client.Web.Helpers.Period;
@inject Presales.PresalesClient PresalesClient
@implements IDisposable
@layout SalesOverviewLayout
@inject IJSRuntime js

@*<style>body {overflow: hidden;}</style>*@

<PageTitle>Sales Overview</PageTitle>

@if (overview == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="overview">
        <div class="legend">
            <fieldset class="salesTarget">
                <legend>План @Format(current.From) - @Format(current.To)</legend>
                <p>@Helpers.ToCurrencyString(overview.CurrentSalesTarget)</p>
            </fieldset>
            <fieldset class="actualProfit">
                <legend>Факт @Format(current.From) - @Format(current.To)</legend>
                <p>@Helpers.ToCurrencyString(overview.CurrentActualProfit)</p>
            </fieldset>
            <fieldset class="previousActualProfit">
                <legend>Факт @Format(previous.From) - @Format(previous.To)</legend>
                <p>@Helpers.ToCurrencyString(overview.PreviousActualProfit)</p>
            </fieldset>
            <fieldset class="increase">
                <legend>Динамика</legend>
                <p>@Helpers.ToCurrencyString(overview.CurrentActualProfit - overview.PreviousActualProfit, true)</p>
            </fieldset>
        </div>
        <div class="chart">
            <div class="charts">
                <div class="buble">
                    <Chart Config="pie"></Chart>
                </div>
                <div class="percent" style="height: @attr_height; width: @attr_width">
                    <p>@Helpers.ToPercentString(overview.CurrentSalesTarget != 0 ? decimal.ToDouble(overview.CurrentActualProfit / overview.CurrentSalesTarget) : 0)</p>
                </div>
            </div>
            <div class="top">
                <fieldset class="leaderboard">
                    <legend>Лидеры продаж</legend>
                    <table>
                        @foreach (var item in overview.CurrentTopSalesManagers.Select((manager, index) => new { index, manager }))
                        {
                            var manager = item.manager;
                            <tr>
                                <td><div style="background:@dataset_сolors[item.index]">&nbsp;</div></td>
                                <td>@(item.index + 1). </td>
                                <td>@manager.Name</td>
                                <td>@Helpers.ToCurrencyString(manager.Profit)</td>
                            </tr>
                        }
                    </table>
                </fieldset>
            </div>
        </div>
    </div>
    <div class="params">
        <div class="@class_hide">
            <label>Предыдущий период:</label>
            <DateOnly_Period Period="previous"
                OnPeriodChangedCallback="(async (Period period) => {previous = period; await UpdateData();})">
            </DateOnly_Period>
            <label>Текущий период:</label>
            <DateOnly_Period Period="current"
                OnPeriodChangedCallback="(async (Period period) => {current = period; await UpdateData();})">
            </DateOnly_Period>
            <button class="btn btn-primary" title="@title_pin" @onclick="PinParams">
                <span class="oi oi-pin @class_rotatePin"></span>
            </button>
            <button class="btn btn-primary" title="Обновить данные" @onclick="UpdateCharts">
                <span class="oi oi-reload"></span>
            </button>
        </div>
    </div>
    <div class="error @class_error_hide">
        <p>@msg_error</p>
    </div>
}

@code {
    private string title_pin = "Закрепить";
    private string class_hide = "hide";
    private string class_error_hide = "error_hide";
    private string class_rotatePin = "rotatePin";
    private string msg_error = "";
    private SalesOverview? overview;
    private static List<string> dataset_сolors = new() { };
    private static string attr_height = "";
    private static string attr_width = "";

    private static readonly DateOnly first_day = new DateOnly(DateTime.Now.Year, (DateTime.Now.Month - 1) / 3 + 1, 1);

    private static Period current = new Period
        {
            From = first_day,
            To = first_day.AddMonths(3).AddDays(-1)
        };

    private static Period previous = new Period
        {
            From = first_day.AddYears(-1),
            To = first_day.AddYears(-1).AddMonths(3).AddDays(-1)
        };

    // private ImageResponse? _img;
    // private PieConfig _pieSmall = new PieConfig();
    private PieConfig pie = new PieConfig();

    private string Format(DateOnly date) => $"{date:dd.MM.yyyy}";

    private void PinParams()
    {
        if (class_hide.Length > 0)
        {
            class_hide = "";
            title_pin = "Открепить";
            class_rotatePin = "";
        }
        else
        {
            class_hide = "hide";
            title_pin = "Закрепить";
            class_rotatePin = "rotatePin";
        }
    }

    private PeriodicTimer periodic_timer = new(TimeSpan.FromMinutes(10));

    private async Task UpdateData()
    {
        try
        {
            overview = await PresalesClient.GetSalesOverviewAsync(new SalesOverviewRequest
                {
                    Previous = previous.Translate(),
                    Current = current.Translate()
                });
        }
        catch
        {
            class_error_hide = "";
            msg_error = "Произошла ошибка при получении ответа от сервера! Попробуйте обновить страницу.";
            StateHasChanged();
            return;
        }
    }

    // private async Task UpdateImage() => _img = await PresalesClient.GetImageAsync(new ImageRequest { Keyword = "happy new year", Orientation = ImageOrientation.Landscape });

    protected override void OnInitialized() => RunTimer();
    public void Dispose() => periodic_timer?.Dispose();

    private async void RunTimer()
    {
        var options = new PieOptions
            {
                Responsive = true,
                Title = new OptionsTitle { Display = false },
                Legend = new Legend { Display = false },
                Tooltips = new Tooltips { Enabled = false },
                CutoutPercentage = 60,
                Animation = new ArcAnimation
                {
                    AnimateScale = true,
                    AnimateRotate = true
                }
            };

        // _pieSmall.Options = options;
        pie.Options = options;

        await UpdateCharts();

        while (await periodic_timer.WaitForNextTickAsync())
        {
            await UpdateCharts();
        }
    }
    private async Task UpdateCharts()
    {
        msg_error = "";
        class_error_hide = "error_hide";

        if (previous.From > previous.To)
        {
            class_error_hide = "";
            msg_error = "Начало предыдущего периода должно быть меньше окончания!";
            StateHasChanged();
            return;
        }

        if (current.From > current.To)
        {
            class_error_hide = "";
            msg_error = "Начало текущего периода должно быть меньше окончания!";
            StateHasChanged();
            return;
        }

        await UpdateData();
        // await UpdateImage();
        if (overview == null) return;

        pie.Data.Datasets.Clear();
        // _pieSmall.Data.Datasets.Clear();

        var rnd = new Random();

        var ds = new PieDataset<decimal>(new decimal[] { });

        foreach (var manager in overview.CurrentTopSalesManagers)
        {
            dataset_сolors.Add(ColorUtil.ColorString(Convert.ToByte(rnd.Next(255)), Convert.ToByte(rnd.Next(255)), Convert.ToByte(rnd.Next(255)), 1));
            ds.Add(manager.Profit);
        }

        var sum = overview.CurrentTopSalesManagers.Sum(m => m.Profit);

        if (overview.CurrentActualProfit > sum)
        {
            dataset_сolors.Add(ColorUtil.ColorString(Convert.ToByte(rnd.Next(255)), Convert.ToByte(rnd.Next(255)), Convert.ToByte(rnd.Next(255)), 1));
            ds.Add(overview.CurrentActualProfit - sum);
        }

        if (overview.CurrentSalesTarget > overview.CurrentActualProfit)
        {
            dataset_сolors.Add(ColorUtil.ColorString(240, 240, 240, 0));
            ds.Add(overview.CurrentSalesTarget - overview.CurrentActualProfit);
        }

        ds.BackgroundColor = dataset_сolors.ToArray();
        ds.BorderWidth = 1;
        ds.BorderAlign = BorderAlign.Center;
        ds.BorderColor = ColorUtil.ColorString(0, 0, 0, 1);
        pie.Data.Datasets.Add(ds);

        StateHasChanged();

        attr_height = $"{await js.InvokeAsync<int>("getHeight")}px";
        attr_width = $"{await js.InvokeAsync<int>("getWidth")}px";

        StateHasChanged();
    }
}
