@* @page "/spreadsheet" *@
@using Department = PresalesApp.Web.Shared.Department
@using Position = PresalesApp.Web.Shared.Position
@implements IDisposable
@using System.Threading

<PageTitle>@Localization["SpreadsheetPage"]</PageTitle>

<h1>@Localization["SpreadsheetPage"]</h1>
<div class="d-flex">
    <PeriodPicker Period="@Period" PeriodChanged="@(async (period) => { Period = period; await UpdateData(); } )" />
    <ComboBox_Departments OnSelectCallback="(async (Department department) => {this.department = department; await UpdateData();})" />
    <ComboBox_Positions OnSelectCallback="(async (Position position) => {this.position = position; await UpdateData();})" />
    <input title="Только действующие" type="checkbox" id="onlyActive" value="@only_active"
            @onchange="((ChangeEventArgs e) => OnStatusChanged(e?.Value))"
            checked class="inline-check inline-check-big" style="cursor: help;" />
</div>
@if (overview == null)
{
    <Loader />
}
else
{
    <table class="table">
        <thead class="pmthead">
            <tr>
                <th rowspan="2" style="width:11%">Пресейл</th>
                <th colspan="10">@Period.GetLocalizedPeriodName(Localization)</th>
                <th rowspan="2" style="width:5%" title="@title_abandoned">Abnd</th>
                <th rowspan="2" style="width:6%" title="@title_avg_time_to_win">AvgTTW</th>
                <th rowspan="2" style="width:5%" title="@title_avg_rank">AvgR</th>
            </tr>
            <tr>
                <th style="width:5%" title="@GetTitleInWork()">InWork</th>
                <th style="width:5%" title="@title_assign">Assign</th>
                <th style="width:5%" title="@title_won">Won</th>
                <th style="width:5%" title="@title_conversion">Convr</th>
                <th style="width:5%" title="@title_loss">Loss</th>
                <th style="width:11%">Потенциал</th>
                <th style="width:10%">Чистые</th>
                <th style="width:6%" title="@title_avg_time_to_reaction">AvgTTR</th>
                <th style="width:4%" title="@title_time_spend">Sum</th>
                <th style="width:4%" title="@title_avt_time_spend">Avg</th>
            </tr>
        </thead>
        <tbody class="pmtbody">
            @foreach (var presale in overview.Presales)
            {
                <tr>
                    <td>@presale.Name.GetFirstAndLastName()</td>
                    <td title="@GetTitleInWork()">@Helpers.ToEmptyIfZeroString(presale.Statistics.InWork)</td>
                    <td title="@title_assign">@Helpers.ToEmptyIfZeroString(presale.Statistics.Assign)</td>
                    <td title="@title_won">@Helpers.ToEmptyIfZeroString(presale.Statistics.Won)</td>
                    <td title="@title_conversion">@Helpers.ToPercentString(presale.Statistics.Conversion)</td>
                    <td title="@title_loss">@Helpers.ToEmptyIfZeroString(presale.Statistics.Loss)</td>
                    <td>@Helpers.ToCurrencyString(presale.Statistics.Potential)</td>
                    <td>@Helpers.ToCurrencyString(presale.Statistics.Profit)</td>
                    <td title="@title_avg_time_to_reaction">@Helpers.ToMinutesString(presale.Statistics.AvgTimeToReaction.ToTimeSpan())</td>
                    <td title="@title_time_spend">@Helpers.ToHoursString(presale.Statistics.SumSpend.ToTimeSpan())</td>
                    <td title="@title_avt_time_spend">@Helpers.ToHoursString(presale.Statistics.AvgSpend.ToTimeSpan())</td>
                    <td title="@title_abandoned">@Helpers.ToEmptyIfZeroString(presale.Statistics.Abnd)</td>
                    <td title="@title_avg_time_to_win">@Helpers.ToDaysString(presale.Statistics.AvgTimeToWin.ToTimeSpan())</td>
                    <td title="@title_avg_rank">@Helpers.ToEmptyIfZeroString(Math.Round(presale.Statistics.AvgRank, 1))</td>
                </tr>
            }
            <tr>
                <td>Всего</td>
                <td title="@GetTitleInWork()">@Helpers.ToEmptyIfZeroString(overview.Statistics.InWork)</td>
                <td title="@title_assign">@Helpers.ToEmptyIfZeroString(overview.Statistics.Assign)</td>
                <td title="@title_won">@Helpers.ToEmptyIfZeroString(overview.Statistics.Won)</td>
                <td title="@title_conversion">@Helpers.ToPercentString(overview.Statistics.Conversion)</td>
                <td title="@title_loss">@Helpers.ToEmptyIfZeroString(overview.Statistics.Loss)</td>
                <td>@Helpers.ToCurrencyString(overview.Statistics.Potential)</td>
                <td>@Helpers.ToCurrencyString(overview.Statistics.Profit)</td>
                <td title="@title_avg_time_to_reaction">@Helpers.ToMinutesString(overview.Statistics.AvgTimeToReaction.ToTimeSpan())</td>
                <td title="@title_time_spend">@Helpers.ToHoursString(overview.Statistics.SumSpend.ToTimeSpan())</td>
                <td title="@title_avt_time_spend">@Helpers.ToHoursString(overview.Statistics.AvgSpend.ToTimeSpan())</td>
                <td title="@title_abandoned">@Helpers.ToEmptyIfZeroString(overview.Statistics.Abnd)</td>
                <td title="@title_avg_time_to_win">@Helpers.ToDaysString(overview.Statistics.AvgTimeToWin.ToTimeSpan())</td>
                <td title="@title_avg_rank">@Math.Round(overview.Statistics.AvgRank, 1)</td>
            </tr>
        </tbody>
    </table>

    @if (overview.AvgDirectorTimeToReaction.Seconds > 0)
    {
        <p>Среднее время реакции руководителя (среднее время до назначения) в минутах: @Helpers.ToMinutesString(overview.AvgDirectorTimeToReaction.ToTimeSpan())</p>
    }
    @if (overview.Escalations.Count > 0)
    {
        <details class="pmspoiler">
            <summary>Проекты с нарушением пунктов 3.1 и 3.2 Регламента (просроченные): @overview.Escalations.Count</summary>
            @foreach (var project in overview.Escalations)
            {
                <p>@Format(project)</p>
            }
        </details>
    }
    @if (overview.Forgotten.Count > 0)
    {
        <details class="pmspoiler">
            <summary>Проекты без отметки начала работы пресейлом (забытые): @overview.Forgotten.Count</summary>
            @foreach (var project in overview.Forgotten)
            {
                <p>@Format(project)</p>
            }
        </details>
    }
    @if (overview.New.Count > 0)
    {
        <details class="pmspoiler">
            <summary>Новые проекты (ожидают распределения): @overview.New.Count</summary>
            @foreach (var project in overview.New)
            {
                <p>@Format(project)</p>
            }
        </details>
    }
}